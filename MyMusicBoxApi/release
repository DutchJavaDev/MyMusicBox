#!/bin/bash
set -e  # Exit immediately if a command exits with a non-zero status

# https://stackoverflow.com/questions/5228345/how-can-i-reference-a-file-for-variables-using-bash
# TODO move folders to single file and include that file in here and in update script
RELEASE_FOLDER="$HOME/mymusicbox_production"
DATABASE_FOLDER="$RELEASE_FOLDER/database"
SCRIPTS_FOLDER="$DATABASE_FOLDER/initscripts"
IMAGES_FOLDER="$RELEASE_FOLDER/music/images"
COOKIES_FOLDER="$RELEASE_FOLDER/selenium"
MIGRATION_FOLDER="$RELEASE_FOLDER/migration_scripts"

echo "=== Setting up release folder ==="

FOLDERS=(
  "$RELEASE_FOLDER"
  "$DATABASE_FOLDER"
  "$SCRIPTS_FOLDER"
  "$IMAGES_FOLDER"
  "$COOKIES_FOLDER"
  "$MIGRATION_FOLDER"
)

for folder in "${FOLDERS[@]}"; do
  if [ ! -d "$folder" ]; then
    mkdir -p "$folder"
    echo "Created: $folder"
  else
    echo "Exists:  $folder"
  fi
done

echo "=== Copying files ==="
cp ../dev_database/docker-compose-release.yml "$DATABASE_FOLDER/docker-compose.yml"
cp ../dev_database/initscripts/* "$SCRIPTS_FOLDER"
cp default/* "$IMAGES_FOLDER"
cp selenium/* "$COOKIES_FOLDER"
cp migration_scripts/* "$MIGRATION_FOLDER"

echo "=== Building executable ==="
go build -buildvcs=false -o "$RELEASE_FOLDER"

echo "=== Starting Docker containers ==="
cd "$DATABASE_FOLDER"
sudo docker compose up -d

echo "=== Restarting mymusic service ==="
sudo systemctl stop mymusic || echo "Service 'mymusic' was not running."
sudo systemctl daemon-reload
sudo systemctl start mymusic

echo "=== Streaming logs ==="
sudo journalctl -u mymusic.service -f

